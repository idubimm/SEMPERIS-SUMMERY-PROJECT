properties([  parameters([ booleanParam(
                                    name: 'IS_DESTROY',
                                    defaultValue: false,
                                    description: 'select if we want to destroy the env instead of building it'
                                )                       
                        ])

])
pipeline {
    agent any 
    stages {
        stage('Checkout Code') {
            steps {
                // Checkout code from Git
                checkout scm
            }
        }
        stage('init terraform build') {
            steps {
                script {
                    if (params.IS_DESTROY) {
                            sh'''
                                #!/bin/bash
                                echo ' this job selected to destroy AWS env , init is ignored'
                                cd ./jenkins-flow-scripts/terraform/
                            '''

                    } else {
                            sh'''
                                #!/bin/bash
                                cd ./jenkins-flow-scripts/terraform/
                                terraform init
                            '''
                     }
                }
            }
        }
        stage('apply terraform changes') {
            steps {
                script {
                    if (params.IS_DESTROY) {
                      echo ' this job selected to destroy AWS env , terraform changes are ignored'
                    } else {
                            sh'''
                                terraform apply -auto-approve
                            '''
                    }
                }
            }
        }
        stage('smoke test that application is running in the load balancer') {
            steps {
                script {
                    if (params.IS_DESTROY) {
                      echo ' this job selected to destroy AWS env , smoke tests are ignored'
                    } else {
                            sh'''
                            chmod -R +x ../bash
                            source ../bash/bash/terraform_utils.sh
                            lb_ip=$(get_load_balance_ip)
                            source ../bash/test-flask-app.sh
                            #                    [1.flask app endpoint]   [2.#retries]  [3.interval secconds]
                            validate_flask_in_loop            $lb_ip         5               1  
                            '''
                    }
                }
            }
        }
        stage('deploy flask app with pre selected scale amount') {
            steps {
                script {
                    sh'''
                    cp ./kubernetes/yaml-files/02-flask.yaml .
                    sed -i "s/REPLICAS/${REPLICAS}/g" 02-flask.yaml
                    kubectl apply -f 02-flask.yaml
                    '''
                }
            }
        }
        stage('deploy LB service') {
            steps {
                script {
                    sh 'kubectl apply -f ./kubernetes/yaml-files/03-services.yaml'
                }
            }
        }

        stage('test sanity for K8 execution') 
        {
            steps {
                script {
                        sh '''#!/bin/bash
                            source jenkins-flow-scripts/bash/kubernetes-utils.sh
                            endpoint=$(get_application_ip_and_port "web-app" "semperis-ns") 
                            source jenkins-flow-scripts/bash/test-flask-app.sh
                                                    [1.flask app endpoint]   [2.#retries]  [3.interval secconds]
                            validate_flask_in_loop     "$endpoint"              5               1             
                        '''
                }
            }
        }

        stage('destroy AWS enviroment') {
            steps {
                script {
                     if (params.IS_DESTROY) {
                        sh 'echo destroying AWS environment'
                     } else {
                         sh '''#!/bin/bash
                        echo "Skipping env destruction"
                        '''
                     }
                }
            }

        }
    }
}